<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Bora... Crescer! ‚Äî v2.2</title>
<meta name="theme-color" content="#0e0f13" />
<style>
  :root{
    --bg:#0e0f13; --panel:#171923; --ink:#e9edff; --muted:#a9b0cf; --line:#2b3042;
    --accent:#f7d040; --accent2:#5fb3ff; --ok:#67e5a1; --warn:#ffb454; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:Inter,Segoe UI,system-ui,-apple-system,Roboto,Arial,sans-serif; background:#0e0f13; color:var(--ink); overflow:hidden}
  .screen{position:absolute; inset:0; display:none; opacity:0; align-items:center; justify-content:center; flex-direction:column; padding:24px; transition:opacity .45s ease}
  .screen.active{display:flex; opacity:1}

  /* Header com logo viva */
  .header{position:absolute; top:0; left:0; right:0; height:72px; display:flex; align-items:center; justify-content:center; padding-inline:16px; border-bottom:1px solid var(--line); pointer-events:none; background:linear-gradient(180deg,rgba(25,27,36,.65),rgba(25,27,36,.2)); backdrop-filter:blur(6px); z-index:10}
  .hdr-logo{position:relative; width:176px; height:42px; pointer-events:auto; display:flex; align-items:center; justify-content:center; opacity:0; transform:translateY(-6px); transition:opacity .6s ease, transform .6s ease}
  .hdr-logo img{height:38px; object-fit:contain; filter:drop-shadow(0 8px 22px rgba(120,150,255,.35))}
  .hdr-logo::after{
    content:""; position:absolute; inset:-40% -30%; border-radius:999px;
    background: radial-gradient(60% 60% at 50% 50%, rgba(95,179,255,.28), transparent 60%),
                radial-gradient(80% 60% at 30% 50%, rgba(247,208,64,.18), transparent 60%);
    filter: blur(14px); opacity:.85; animation:breath 3.4s ease-in-out infinite;
  }
  @keyframes breath{0%,100%{transform:scale(1)} 50%{transform:scale(1.06)}}
  .hdr-gear{position:absolute; right:16px; font-size:20px; color:#9fb6e9; cursor:pointer; pointer-events:auto; opacity:0; transform:translateY(-6px); transition:opacity .6s ease, transform .6s ease, filter .2s ease}
  .hdr-gear:hover{filter:drop-shadow(0 0 8px rgba(95,179,255,.5))}
  .hdr-active .hdr-logo,.hdr-active .hdr-gear{opacity:1; transform:none}

  /* Fundo met√°lico com grid leve */
  .evo{position:fixed; inset:0; pointer-events:none; opacity:0; transition:opacity 1s ease}
  .evo.show{opacity:1}
  .evo:before{
    content:""; position:absolute; inset:-10%; background:
      radial-gradient(1200px 600px at 70% -10%, #1a1d29 0%, transparent 60%),
      radial-gradient(900px 500px at 20% 110%, #122338 0%, transparent 60%),
      linear-gradient(180deg,#0f1118, #0b0c12 60%);
  }
  .evo:after{
    content:""; position:absolute; inset:0;
    background: repeating-linear-gradient(135deg, rgba(255,255,255,.04) 0 2px, transparent 2px 6px);
    mix-blend-mode:overlay; opacity:.25;
  }

  /* Splash */
  #splash{background:linear-gradient(145deg,#1b1d26,#0e0f13)}
  .splash-wrap{position:relative; display:flex; align-items:center; justify-content:center; flex-direction:column}
  .splash-img{width:220px; height:220px; border-radius:50%; display:grid; place-items:center; opacity:0; transform:scale(.92); animation:logoIn 2.6s ease forwards}
  .splash-img img{width:72%; height:72%; object-fit:contain; filter:drop-shadow(0 12px 28px rgba(120,150,255,.35))}
  .splash-img::before{
    content:""; position:absolute; inset:-8%; border-radius:50%;
    background: conic-gradient(from 0deg, rgba(95,179,255,.35), rgba(247,208,64,.22), rgba(95,179,255,.35));
    filter: blur(20px); animation:spinGlow 5.5s linear infinite;
  }
  .nano-line{width:320px; height:1px; background:linear-gradient(90deg,transparent,#6b7cff,#30d5ff,transparent); margin-top:18px; opacity:0; animation:nano 2.2s .6s ease forwards}
  @keyframes logoIn{0%{opacity:0} 40%{opacity:1; transform:scale(1)} 100%{opacity:1; transform:scale(1)}}
  @keyframes spinGlow{to{transform:rotate(360deg)}}
  @keyframes nano{to{opacity:.75}}

  /* Cards e bot√µes */
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:14px; padding:20px; width:min(760px,94vw); box-shadow:0 10px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.03); position:relative}
  .hint{color:var(--muted); font-size:.92rem; margin-top:6px}
  .row{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
  .btn{background:linear-gradient(180deg,#2a2f3b,#1c1f26); border:1px solid #3a3f4f; color:#e9eeff; padding:12px 16px; border-radius:10px; font-weight:800; cursor:pointer; transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease}
  .btn:hover{border-color:#4c5470}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background: radial-gradient(140% 120% at 30% -20%, rgba(247,208,64,.2), transparent 50%), linear-gradient(180deg,#2e2a18,#171612); border-color:#6b5c1f; color:#ffe6a2}
  .btn-outline{background:transparent; border:1px solid #3a4050; color:#cfe3ff}
  .bar{height:1px; background:#2e3342; margin:16px 0}

  /* Avatares */
  .avatar-row{display:flex; gap:16px; flex-wrap:wrap; justify-content:center; margin-top:10px}
  .avatar{width:96px; height:96px; border-radius:50%; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:6px; background:linear-gradient(180deg,#1e2027,#16171c); cursor:pointer; transition:transform .18s ease, border-color .18s ease}
  .avatar:hover{transform:translateY(-3px); border-color:var(--accent)}
  .avatar span{font-size:28px}
  .avatar label{font-size:.78rem; color:#c9cfe8}

  /* √çcones de op√ß√µes */
  .opt-grid{display:grid; grid-template-columns:repeat(2,minmax(180px,1fr)); gap:12px; width:min(760px,94vw)}
  .opt-card{border:1px solid var(--line); border-radius:14px; padding:14px; background:linear-gradient(180deg,#1b1e27,#14161c); display:flex; align-items:center; gap:12px; cursor:pointer; transition:transform .12s ease, border-color .2s ease}
  .opt-card:hover{transform:translateY(-2px); border-color:#4c5470}
  .opt-ico{font-size:24px}

  /* Perguntas (ajustes para caber sem deslocar) */
  .qhead{display:flex; align-items:flex-start; justify-content:space-between; gap:8px}
  .badge{display:flex; align-items:center; gap:8px}
  .dot{width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-size:14px; color:#0b0c12; font-weight:900}
  .area-badge{color:var(--accent); text-transform:uppercase; letter-spacing:.08em; font-size:.82rem}
  .level-badge{color:#90c7ff; font-size:.8rem}
  .progress{color:#9aa4c8; font-size:.9rem}
  .q-actions{display:flex; align-items:center; gap:8px}
  .ex-icon{border:1px dashed #3b4157; padding:6px 10px; border-radius:999px; cursor:pointer; background:#1b1e29}
  .ex-icon:hover{border-color:#6b7cff}
  .ex-tip{margin-top:10px; background:#101219; border:1px solid #2e3446; border-radius:12px; padding:10px 12px; font-size:.92rem; color:#cfe2ff; display:none}
  .ex-tip.show{display:block}
  .question{font-size:1.14rem; line-height:1.5; margin-top:8px; min-height:3.2em}
  .likert{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
  .opt{flex:1 1 150px; padding:10px; border:1px solid #41465a; border-radius:10px; background:#232633; color:#d6dcff; font-weight:800; cursor:pointer; text-align:center; transition:border-color .15s ease, transform .05s ease, box-shadow .2s ease}
  .opt:hover{border-color:var(--accent)}
  .opt.active{border-color:var(--accent); box-shadow:0 0 0 6px rgba(247,208,64,.08)}
  .qfooter{display:flex; align-items:center; justify-content:space-between; margin-top:10px; min-height:24px}
  #exTip{min-height:0}
  #likert{min-height:56px}

  /* Emo√ß√£o (centralizada) */
  .emotion-wrap{margin-top:12px}
  .emo-title{margin-top:10px; margin-bottom:10px; text-align:center}
  .emojis{display:flex; gap:12px; justify-content:center}
  .emo{font-size:32px; cursor:pointer; transition:transform .1s ease}
  .emo:hover{transform:scale(1.08)}
  .emo.active{filter:drop-shadow(0 0 8px rgba(95,179,255,.55))}
  .after-emo{height:10px}

  /* Resultados */
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:1100px){.grid{grid-template-columns:1.2fr .85fr}}
  .diamond{width:100%; aspect-ratio:1.6 / 1; border:1px dashed #383e50; border-radius:12px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden}
  .diamond svg{width:92%; height:92%}
  .pill{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); background:#171922; padding:8px 10px; border-radius:999px; font-size:.9rem}
  .tag{font-size:.78rem; color:#aab3d4}
  .kpi{display:flex; align-items:center; justify-content:space-between; border:1px solid var(--line); background:#171922; border-radius:12px; padding:12px 14px}
  .note{font-size:.96rem; color:#cfd7ff}
  .muted{color:#9aa4c8; font-size:.9rem}

  /* Cabe√ßalho m√≥vel (toggle) */
  .card-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  .card-head-title{display:flex; align-items:center; gap:8px; font-weight:800}
  .toggle{cursor:pointer; user-select:none; font-size:18px; opacity:.9}

  /* Filtros */
  .filters{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0}
  select{background:#14151a; color:#e7ecff; border:1px solid #343948; border-radius:10px; padding:8px 10px}
  .mini{width:100%; height:160px; border:1px dashed #2e3342; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(7,8,12,.86); padding:20px; z-index:40}
  .modal.show{display:flex}
  .modal .sheet{width:min(960px,96vw); max-height:85vh; overflow:auto; background:linear-gradient(180deg,#171a22,#12141a); border:1px solid #2c3243; border-radius:16px; padding:16px}
  .area-title{font-weight:900; color:#e9edff; margin-top:4px}
  .q-item{padding:8px 0; border-bottom:1px dashed #2e3342; color:#cfd7ff; font-size:.95rem}

  /* Config */
  .config-sheet .row{justify-content:flex-start}

  /* Cores por √°rea */
  .A0{--c:#ffcc66; --b:solid}
  .A1{--c:#66d2ff; --b:dashed}
  .A2{--c:#67e5a1; --b:solid}
  .A3{--c:#ffd36e; --b:double}
  .A4{--c:#b097ff; --b:dashed}
  .A5{--c:#8bd0ff; --b:solid}
  .A6{--c:#ffa3a3; --b:dashed}
  .A7{--c:#a0ffcf; --b:solid}
  .A8{--c:#ffc38f; --b:double}
  .A9{--c:#ff9bd6; --b:solid}
  .A10{--c:#b6ff7a; --b:dashed}
  .A11{--c:#9bd1ff; --b:solid}
  .A12{--c:#ffd3a0; --b:double}
  .A13{--c:#a7ffec; --b:dashed}
  .A14{--c:#c4caff; --b:solid}
  .cat-border{border:2px var(--b) var(--c) !important; box-shadow:0 0 0 6px color-mix(in oklab, var(--c) 18%, transparent)}

  /* Contagem regressiva (wipe) */
  .wipe{position:fixed; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; background:radial-gradient(1200px 800px at 50% -10%, #121521 0%, #0b0c12 60%); z-index:50}
  .wipe.show{display:flex}
  .wipe .count{font-size:72px; font-weight:900; letter-spacing:.02em}
  .wipe .phrase{margin-top:10px; font-size:1.05rem; color:#cfe2ff}

  /* Fade extra para quando a logo some */
  .hdr-logo[style*="opacity: 0"] img { filter:none !important; }
</style>
</head>
<body>
  <!-- Header -->
  <div class="header" id="appHeader">
    <div class="hdr-logo"><img src="123.png" alt="Bora... Crescer!"></div>
    <div class="hdr-gear" id="btnConfig" title="Configura√ß√µes">‚öôÔ∏è</div>
  </div>

  <!-- Fundo -->
  <div class="evo" id="evoBg" aria-hidden="true"></div>

  <!-- Splash -->
  <section id="splash" class="screen active" aria-hidden="false">
    <div class="splash-wrap">
      <div class="splash-img"><img src="123.png" alt="Bora... Crescer!"></div>
      <div class="nano-line"></div>
    </div>
  </section>

  <!-- 1) Tela: Quem √© voc√™ -->
  <section id="login" class="screen" aria-hidden="true">
    <div class="card" style="text-align:center">
      <h2 style="margin:0 0 6px 0">Quem √© voc√™?</h2>
      <div class="hint">Escolha um perfil (m√°x. 3) ou cadastre um novo.</div>
      <div class="avatar-row" id="avatarRow"></div>
      <div class="bar"></div>
      <div class="row">
        <button class="btn btn-outline" id="btnRegister">Cadastrar Novo Perfil</button>
      </div>
    </div>
  </section>

  <!-- 2) Tela: Op√ß√µes -->
  <section id="options" class="screen" aria-hidden="true">
    <div class="card" style="text-align:center">
      <h2 style="margin:0 0 6px 0">O que deseja fazer?</h2>
      <div class="hint">Selecione uma op√ß√£o.</div>

      <div class="opt-grid" style="margin-top:12px">
        <div class="opt-card" id="optStart"><div class="opt-ico">üöÄ</div><div><strong>Come√ßar</strong><div class="muted">Iniciar avalia√ß√£o de hoje</div></div></div>
        <div class="opt-card" id="optQuestions"><div class="opt-ico">üìö</div><div><strong>Perguntas por N√≠vel</strong><div class="muted">Visualizar base (opaco)</div></div></div>
        <div class="opt-card" id="optConfig"><div class="opt-ico">‚öôÔ∏è</div><div><strong>Configura√ß√µes</strong><div class="muted">Dados e reset</div></div></div>
        <div class="opt-card" id="optBack"><div class="opt-ico">‚Ü©Ô∏è</div><div><strong>Voltar</strong><div class="muted">Trocar usu√°rio</div></div></div>
      </div>
    </div>
  </section>

  <!-- 3) Wipe + Contagem -->
  <div class="wipe" id="wipe">
    <div class="count" id="countNum">5</div>
    <div class="phrase" id="countPhrase">Respira. Consist√™ncia vence talento distra√≠do.</div>
  </div>

  <!-- 4) Perguntas -->
  <section id="questions" class="screen" aria-hidden="true">
    <div class="card cat-border" id="qCard">
      <div class="qhead">
        <div class="badge">
          <div class="dot" id="areaDot">üß≠</div>
          <div>
            <div class="area-badge" id="areaBadge">√Årea: ‚Äî</div>
            <div class="level-badge" id="levelBadge">N√≠vel: ‚Äî</div>
          </div>
        </div>
        <div class="q-actions">
          <div class="progress" id="progress">1/20</div>
          <div class="ex-icon" id="btnExample" title="Ver exemplo">üí°</div>
        </div>
      </div>
      <div class="ex-tip" id="exTip"></div>

      <div class="question" id="questionText">‚Äî</div>
      <div class="likert" id="likert">
        <button class="opt" data-v="1">Discordo Fortemente</button>
        <button class="opt" data-v="2">Discordo</button>
        <button class="opt" data-v="3">Neutro / √Äs Vezes</button>
        <button class="opt" data-v="4">Concordo</button>
        <button class="opt" data-v="5">Concordo Fortemente</button>
      </div>

      <div class="emotion-wrap">
        <h3 class="emo-title">Como voc√™ se sente hoje?</h3>
        <div class="emojis" id="emojis">
          <span class="emo" data-e="1">üòî</span>
          <span class="emo" data-e="2">üòü</span>
          <span class="emo" data-e="3">üòê</span>
          <span class="emo" data-e="4">üôÇ</span>
          <span class="emo" data-e="5">üòÉ</span>
        </div>
        <div class="after-emo"></div>
      </div>

      <div class="qfooter">
        <div class="hint">Responda com sinceridade. Simplicidade > perfei√ß√£o.</div>
        <div class="progress" id="progressFoot">1/20</div>
      </div>
    </div>
  </section>

  <!-- 5) Resultados -->
  <section id="results" class="screen" aria-hidden="true" style="align-items:stretch">
    <div class="grid" style="margin:auto; width:min(1200px,96vw)">

      <!-- Gr√°fico Geral -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-title"><span>üìà</span><span>Evolu√ß√£o ‚Äî Hoje vs. √öltima</span></div>
          <div class="tag" id="resultDateTag">‚Äî</div>
        </div>
        <div class="diamond" id="diamondWrap"></div>
        <div class="hint">Pol√≠gono cheio = hoje | Pontilhado = √∫ltima avalia√ß√£o.</div>
      </div>

      <!-- KPIs + An√°lise -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-title"><span>üß≠</span><span>An√°lise & KPIs</span></div>
          <div class="toggle" id="togAnalise" title="Mostrar/ocultar">‚ñº</div>
        </div>
        <div id="analiseBody">
          <div class="kpi"><span>Nota Geral</span><strong id="kpiGeral">‚Äî</strong></div>
          <div style="height:8px"></div>
          <div class="kpi"><span>Emo√ß√£o do Dia</span><strong id="kpiEmo">‚Äî</strong></div>
          <div style="height:8px"></div>
          <div class="kpi"><span>√Åreas em Aten√ß√£o</span><strong id="kpiAtencao">‚Äî</strong></div>
          <div class="bar"></div>
          <div class="note" id="aiCritica"><strong>Cr√≠tica:</strong> ‚Äî</div>
          <div style="height:6px"></div>
          <div class="note" id="aiRecon"><strong>Reconhecimento:</strong> ‚Äî</div>
        </div>
      </div>

      <!-- Evolu√ß√£o por √Årea & Per√≠odo -->
      <div class="card" style="grid-column:1 / -1">
        <div class="card-head">
          <div class="card-head-title"><span>üóÇÔ∏è</span><span>Evolu√ß√£o por √Årea & Per√≠odo</span></div>
          <div class="filters">
            <select id="selArea"></select>
            <select id="selPeriodo">
              <option value="7">7 dias</option>
              <option value="30" selected>30 dias</option>
              <option value="90">90 dias</option>
              <option value="all">Tudo</option>
            </select>
          </div>
        </div>
        <div class="mini" id="miniChart">‚Äî</div>
      </div>

      <!-- Melhorias & Elogios -->
      <div class="card" style="grid-column:1 / -1">
        <div class="card-head">
          <div class="card-head-title"><span>üîß</span><span>Melhorias & Elogios</span></div>
        </div>
        <div id="improveList" class="note">‚Äî</div>
        <div class="bar"></div>
        <div id="praiseList" class="note">‚Äî</div>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-outline" id="btnFinish">Finalizar e reiniciar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal: Perguntas por n√≠vel -->
  <div class="modal" id="modalQuestions" aria-hidden="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">Perguntas por √Årea & N√≠vel</h3>
        <button class="btn" id="btnCloseModal">Fechar</button>
      </div>
      <div id="areaList"></div>
    </div>
  </div>

  <!-- Modal: Config -->
  <div class="modal" id="modalConfig" aria-hidden="true">
    <div class="sheet config-sheet">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">Configura√ß√µes</h3>
        <button class="btn" id="btnCloseConfig">Fechar</button>
      </div>
      <div class="bar"></div>
      <div class="row">
        <button class="btn btn-outline" id="btnResetUser">Limpar dados do usu√°rio atual</button>
        <button class="btn btn-outline" id="btnResetAll">Resetar TUDO (perfis, n√≠veis, hist√≥rico)</button>
      </div>
      <div class="hint">* Usa localStorage; a√ß√£o irrevers√≠vel.</div>
    </div>
  </div>

<script>
/* ====== Util ====== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

/* ====== √Åreas + √≠cones ====== */
const AREAS = [
  "Autoconhecimento","Resili√™ncia Emocional","Sa√∫de F√≠sica B√°sica","Performance e Vitalidade",
  "Aprendizado Cont√≠nuo","Pensamento Cr√≠tico","Carreira e Prop√≥sito","Finan√ßas Pessoais",
  "Investimento e Riqueza","Relacionamentos √çntimos","C√≠rculo Social","Lazer e Cultura",
  "Espiritualidade","Contribui√ß√£o Social","Ambiente e Organiza√ß√£o"
];
const AREA_ICONS = {
  "Autoconhecimento":"üß≠","Resili√™ncia Emocional":"üß†","Sa√∫de F√≠sica B√°sica":"üí™","Performance e Vitalidade":"‚ö°",
  "Aprendizado Cont√≠nuo":"üìö","Pensamento Cr√≠tico":"üß©","Carreira e Prop√≥sito":"üéØ","Finan√ßas Pessoais":"üíº",
  "Investimento e Riqueza":"üìà","Relacionamentos √çntimos":"üíû","C√≠rculo Social":"ü§ù","Lazer e Cultura":"üé®",
  "Espiritualidade":"‚ú®","Contribui√ß√£o Social":"üåç","Ambiente e Organiza√ß√£o":"üßπ"
};

/* ====== 500 perguntas + exemplos ====== */
const LEVEL_PATTERNS = {
  n1: [
    "Hoje voc√™ fez 1 micro-a√ß√£o pr√°tica ligada a {area}?",
    "Voc√™ reservou 10‚Äì15 minutos para {area_acao}?",
    "Voc√™ registrou 1 pequeno avan√ßo em {area}?",
    "Voc√™ removeu 1 barreira simples que atrapalha {area_acao}?",
    "Voc√™ pediu ajuda ou usou um lembrete para {area_acao}?",
    "Voc√™ repetiu 1 h√°bito b√°sico de {area} sem falhar?",
    "Voc√™ evitou 1 distra√ß√£o que sabota {area}?",
    "Voc√™ fechou o dia com 1 anota√ß√£o curta sobre {area}?",
    "Voc√™ aplicou 1 dica simples que j√° conhecia em {area}?",
    "Voc√™ manteve const√¢ncia m√≠nima em {area} hoje?",
    "Voc√™ celebrou 1 passo pequeno em {area}?"
  ],
  n2: [
    "Voc√™ transformou reflex√£o em a√ß√£o concreta em {area}?",
    "Voc√™ planejou e executou 1 rotina semanal para {area}?",
    "Voc√™ mediu seu progresso em {area} (mesmo que simples)?",
    "Voc√™ comparou 2 alternativas e escolheu uma melhor para {area}?",
    "Voc√™ revisou seu processo de {area_acao} para ficar mais leve?",
    "Voc√™ fez 1 ajuste de ambiente para facilitar {area_acao}?",
    "Voc√™ ensinou algu√©m 1 pr√°tica relacionada a {area}?",
    "Voc√™ pediu feedback sobre {area} e agiu em cima dele?",
    "Voc√™ integrou {area} com outra √°rea da vida para ganhar efici√™ncia?",
    "Voc√™ criou 1 checklist r√°pido para {area_acao}?",
    "Voc√™ antecipou 1 risco e preveniu um problema ligado a {area}?"
  ],
  n3: [
    "Voc√™ sustentou {area} com qualidade mesmo sob press√£o?",
    "Voc√™ desenhou um mini-sistema est√°vel para {area_acao}?",
    "Voc√™ documentou e padronizou 1 boa pr√°tica de {area}?",
    "Voc√™ otimizou 1 gargalo de {area_acao} que j√° te atrasava?",
    "Voc√™ criou 1 m√©trica simples para avaliar {area} semanalmente?",
    "Voc√™ apoiou outra pessoa a evoluir em {area}?",
    "Voc√™ fez 1 revis√£o cr√≠tica e removeu desperd√≠cios em {area}?",
    "Voc√™ replicou sua pr√°tica de {area} em outro contexto com sucesso?",
    "Voc√™ conectou {area} a um objetivo maior (trimestre/ano)?",
    "Voc√™ garantiu continuidade de {area} com plano claro de manuten√ß√£o?",
    "Voc√™ avaliou resultados e corrigiu rotas em {area} sem apego?"
  ]
};
const EXAMPLES = {
  "Autoconhecimento": { n1:"Ex.: 10 min de sil√™ncio e anotar 3 sensa√ß√µes.",
    n2:"Ex.: Definir 1 valor-guia e us√°-lo numa decis√£o.",
    n3:"Ex.: Escrever miss√£o em 3 linhas e dizer 'n√£o' ao que n√£o alinha." },
  "Resili√™ncia Emocional": { n1:"Ex.: 3 ciclos 4-4-6 antes de responder.",
    n2:"Ex.: Nomear emo√ß√£o e pedir 5 min para retomar.",
    n3:"Ex.: Plano anti-reca√≠da: sono, telas, gatilhos, pedir ajuda." },
  "Sa√∫de F√≠sica B√°sica": { n1:"Ex.: 7‚Äì8h sono; hidrata√ß√£o vis√≠vel.",
    n2:"Ex.: Marmitas simples; telas off 1h antes de dormir.",
    n3:"Ex.: Check-up agendado e rotina padronizada." },
  "Performance e Vitalidade": { n1:"Ex.: 25min foco + 2min pausa.",
    n2:"Ex.: 3 MITs/dia e ajuste do ambiente.",
    n3:"Ex.: 2‚Äì3 blocos/dia com revis√£o semanal." },
  "Aprendizado Cont√≠nuo": { n1:"Ex.: 1 conceito + 3 bullets anotados.",
    n2:"Ex.: Aplicar t√©cnica e registrar resultado.",
    n3:"Ex.: Ensinar o conte√∫do para algu√©m." },
  "Pensamento Cr√≠tico": { n1:"Ex.: Definir o problema em 3 linhas.",
    n2:"Ex.: Buscar vis√£o contr√°ria e checar fonte.",
    n3:"Ex.: P√≥s-mortem: o que, por qu√™, o que muda." },
  "Carreira e Prop√≥sito": { n1:"Ex.: Pedir 1 feedback aberto hoje.",
    n2:"Ex.: 1 a√ß√£o ligada √† meta do trimestre.",
    n3:"Ex.: Mentoria r√°pida ou indica√ß√£o concreta." },
  "Finan√ßas Pessoais": { n1:"Ex.: Registrar 100% dos gastos do dia.",
    n2:"Ex.: Revisar or√ßamento e cortar 1 sup√©rfluo.",
    n3:"Ex.: Automatizar pagamento/investimento." },
  "Investimento e Riqueza": { n1:"Ex.: Aporte no valor planejado.",
    n2:"Ex.: Rebalancear por regra; n√£o por manchete.",
    n3:"Ex.: Escrever pol√≠tica simples de investimento." },
  "Relacionamentos √çntimos": { n1:"Ex.: 15 min de presen√ßa real.",
    n2:"Ex.: Agendar tempo de qualidade intencional.",
    n3:"Ex.: Revisar sonhos/metas juntos." },
  "C√≠rculo Social": { n1:"Ex.: Mensagem sincera a um amigo.",
    n2:"Ex.: Apresentar duas pessoas que se ajudam.",
    n3:"Ex.: Reunir 3 pessoas com prop√≥sito." },
  "Lazer e Cultura": { n1:"Ex.: 20‚Äì30 min de hobby/arte.",
    n2:"Ex.: Bloquear 1h de lazer na semana.",
    n3:"Ex.: Criar 1 pe√ßa: esbo√ßo/texto/foto." },
  "Espiritualidade": { n1:"Ex.: Gratid√£o com 3 itens.",
    n2:"Ex.: Estudar um trecho e refletir.",
    n3:"Ex.: Servir algu√©m/comunidade." },
  "Contribui√ß√£o Social": { n1:"Ex.: Melhorar o dia de algu√©m.",
    n2:"Ex.: Participar de iniciativa social.",
    n3:"Ex.: Estruturar microprojeto com 1 meta." },
  "Ambiente e Organiza√ß√£o": { n1:"Ex.: Mesa funcional, sem tralha.",
    n2:"Ex.: Sistema √∫nico de tarefas/calend√°rio.",
    n3:"Ex.: Remover 1 desperd√≠cio do fluxo." }
};
function alias(area){
  const map={
    "Autoconhecimento":"se ouvir","Resili√™ncia Emocional":"se regular emocionalmente","Sa√∫de F√≠sica B√°sica":"cuidar do corpo",
    "Performance e Vitalidade":"performar com energia","Aprendizado Cont√≠nuo":"aprender","Pensamento Cr√≠tico":"analisar com crit√©rio",
    "Carreira e Prop√≥sito":"direcionar a carreira","Finan√ßas Pessoais":"organizar finan√ßas","Investimento e Riqueza":"investir",
    "Relacionamentos √çntimos":"nutrir a rela√ß√£o","C√≠rculo Social":"cultivar amizades","Lazer e Cultura":"viver cultura/lazer",
    "Espiritualidade":"praticar espiritualidade","Contribui√ß√£o Social":"contribuir com a sociedade","Ambiente e Organiza√ß√£o":"organizar o ambiente"
  }; return map[area]||"agir no tema";
}
function genBase(){
  const BASE={};
  AREAS.forEach((area,idx)=>{
    const out={n1:[],n2:[],n3:[]};
    LEVEL_PATTERNS.n1.forEach(p=>{
      out.n1.push([p.replace("{area}",area).replace("{area_acao}",alias(area)), EXAMPLES[area].n1]);
    });
    const n2p=[...LEVEL_PATTERNS.n2];
    if(idx<5) n2p.push("Voc√™ consolidou o aprendizado de {area} em 1 p√°gina?");
    n2p.forEach(p=>{
      const q=p.replace("{area}",area).replace("{area_acao}",alias(area));
      const ex = p.includes("consolidou o aprendizado") ? "Ex.: P√°gina-s√≠ntese com conceitos, exemplos e aplica√ß√£o." : EXAMPLES[area].n2;
      out.n2.push([q, ex]);
    });
    LEVEL_PATTERNS.n3.forEach(p=>{
      out.n3.push([p.replace("{area}",area).replace("{area_acao}",alias(area)), EXAMPLES[area].n3]);
    });
    BASE[area]=out;
  });
  return BASE;
}
const BASE_Q = genBase();

/* ====== Estado ====== */
let state = {
  user:null,
  sessionDate:null,
  drawn:[], idx:0, answers:[], emotion:null, lastSession:null,
};

/* ====== Persist√™ncia ====== */
function keyUsers(){return 'bc_users'}
function keyHist(user){return `bc_hist_${user}`}
function keyLevels(user){return `bc_levels_${user}`}
const DEFAULT_USERS = [{name:"Rafa",icon:"üë§"},{name:"Nina",icon:"üßë‚ÄçüöÄ"},{name:"Kai",icon:"üë©‚Äçüíª"}];
function getUsers(){ try{ return JSON.parse(localStorage.getItem(keyUsers())||'null') || DEFAULT_USERS; }catch{ return DEFAULT_USERS; } }
function setUsers(list){ localStorage.setItem(keyUsers(), JSON.stringify(list)); }
function getLevels(user){ try{ const raw=JSON.parse(localStorage.getItem(keyLevels(user))||'null'); if(raw) return raw; }catch{} const init={}; AREAS.forEach(a=>init[a]={level:1,streak:0}); return init; }
function setLevels(user, levels){ localStorage.setItem(keyLevels(user), JSON.stringify(levels)); }
function pushHistory(user, payload){ const k=keyHist(user); const hist=JSON.parse(localStorage.getItem(k)||'[]'); hist.push(payload); localStorage.setItem(k, JSON.stringify(hist)); return hist; }
function getHistory(user){ return JSON.parse(localStorage.getItem(keyHist(user)||'[]')) || []; }
function getLastHistory(user){ const k=keyHist(user); const hist=JSON.parse(localStorage.getItem(k)||'[]'); return hist.length? hist[hist.length-1] : null; }

/* ====== Navega√ß√£o ====== */
function goto(id){
  $$('.screen').forEach(s=>{ s.classList.remove('active'); s.setAttribute('aria-hidden','true'); });
  const el = '#'+id;
  $(el).classList.add('active'); $(el).setAttribute('aria-hidden','false');
}
function headerActive(on=true){ const hdr = $('#appHeader'); on?hdr.classList.add('hdr-active'):hdr.classList.remove('hdr-active'); }
function evo(on=true){ const e = $('#evoBg'); on?e.classList.add('show'):e.classList.remove('show'); }

/* Splash -> Login (6s) + esconder logo do header */
setTimeout(()=>{
  headerActive(true);
  evo(true);
  goto('login');
  bootstrapAvatars();

  // fade-out da logo do header e remove do layout
  const logo = document.querySelector('.hdr-logo');
  if (logo) {
    logo.style.transition = 'opacity .6s ease, transform .6s ease';
    logo.style.opacity = '0';
    logo.style.transform = 'translateY(-8px)';
    setTimeout(()=>{ logo.style.display = 'none'; }, 650);
  }
}, 6000);

/* Avatares */
function bootstrapAvatars(){
  const row = $('#avatarRow'); row.innerHTML='';
  getUsers().slice(0,3).forEach(u=>{
    const div = document.createElement('div');
    div.className='avatar';
    div.innerHTML=`<span>${u.icon}</span><label>${u.name}</label>`;
    div.addEventListener('click', ()=>selectUser(u));
    row.appendChild(div);
  });
}
function selectUser(u){
  state.user = u;
  state.lastSession = getLastHistory(u.name);
  goto('options');
}

/* Op√ß√µes */
$('#optBack').addEventListener('click', ()=>goto('login'));
$('#optConfig').addEventListener('click', ()=>$('#modalConfig').classList.add('show'));
$('#optQuestions').addEventListener('click', ()=>{
  const areaList = $('#areaList'); areaList.innerHTML='';
  AREAS.forEach(area=>{
    const box = document.createElement('div');
    box.className='card'; box.style.marginTop='12px';
    const n1 = BASE_Q[area].n1, n2 = BASE_Q[area].n2, n3 = BASE_Q[area].n3;
    box.innerHTML = `
      <div class="area-title">${AREA_ICONS[area]} ${area}</div>
      <div class="tag">N√≠vel 1 (B√°sico)</div>
      <div>${n1.slice(0,5).map(([q])=>`<div class="q-item">${q}</div>`).join('')}</div>
      <div class="tag" style="margin-top:10px">N√≠vel 2 (Intermedi√°rio)</div>
      <div>${n2.slice(0,5).map(([q])=>`<div class="q-item">${q}</div>`).join('')}</div>
      <div class="tag" style="margin-top:10px">N√≠vel 3 (Avan√ßado)</div>
      <div>${n3.slice(0,5).map(([q])=>`<div class="q-item">${q}</div>`).join('')}</div>
    `;
    areaList.appendChild(box);
  });
  $('#modalQuestions').classList.add('show');
});

/* Come√ßar -> wipe + 5s -> perguntas */
const PHRASES=[
  "Respira. Consist√™ncia vence talento distra√≠do.",
  "Pequenos passos, grandes rota√ß√µes.",
  "Disciplina √© liberdade.",
  "Sem pressa, sem pausa.",
  "Foco no que mexe o ponteiro."
];
$('#optStart').addEventListener('click', ()=>{
  startSession();
  runWipe(()=>{ renderQuestion(); goto('questions'); });
});
function startSession(){
  state.sessionDate = new Date().toISOString().slice(0,10);
  state.answers=[]; state.idx=0; state.emotion=null;
  const levels = getLevels(state.user.name);
  state.drawn = drawDaily20(levels);
  state.lastSession = getLastHistory(state.user.name);
}
function runWipe(done){
  const w = $('#wipe'); const c = $('#countNum'); const p = $('#countPhrase');
  let left=5; p.textContent = PHRASES[Math.floor(Math.random()*PHRASES.length)];
  w.classList.add('show'); c.textContent = left;
  const t = setInterval(()=>{
    left--; if(left<=0){ clearInterval(t); w.classList.remove('show'); done(); }
    else{ c.textContent = left; }
  },1000);
}

/* Modais */
$('#btnCloseModal').addEventListener('click', ()=>$('#modalQuestions').classList.remove('show'));
$('#btnConfig').addEventListener('click', ()=>$('#modalConfig').classList.add('show'));
$('#btnCloseConfig').addEventListener('click', ()=>$('#modalConfig').classList.remove('show'));
$('#btnResetUser').addEventListener('click', ()=>{
  if(!state.user) return alert('Selecione um usu√°rio.');
  if(!confirm('Limpar hist√≥rico e n√≠veis do usu√°rio atual?')) return;
  localStorage.removeItem(keyHist(state.user.name));
  localStorage.removeItem(keyLevels(state.user.name));
  alert('Dados do usu√°rio atual limpos.');
});
$('#btnResetAll').addEventListener('click', ()=>{
  if(!confirm('RESET TOTAL? (Perfis, n√≠veis, hist√≥rico)')) return;
  localStorage.clear(); alert('Tudo limpo. Recarregue a p√°gina.');
});

/* Cadastro */
$('#btnRegister').addEventListener('click', ()=>{
  const name = prompt('Nome do novo perfil:'); if(!name) return;
  const icon = prompt('Emoji/√≠cone para o avatar (ex: üòé):') || 'üôÇ';
  const users = getUsers(); users.unshift({name,icon}); setUsers(users.slice(0,3)); bootstrapAvatars();
});

/* Sorteio 20/dia */
function drawDaily20(levels){
  const areas = shuffle([...AREAS]).slice(0,10);
  const pack=[];
  areas.forEach(area=>{
    const lv = clamp(levels[area]?.level||1,1,3);
    const list = BASE_Q[area][lv===1?'n1':lv===2?'n2':'n3'];
    const picks = samplePairs(list);
    const aIdx = AREAS.indexOf(area);
    picks.forEach(([question,example])=>pack.push({area, level:lv, question, example, areaIndex:aIdx}));
  });
  return shuffle(pack);
}
function samplePairs(arr){ const c=[...arr]; const out=[]; for(let k=0;k<2;k++){ if(!c.length) c.push(...arr); const idx = Math.floor(Math.random()*c.length); out.push(c.splice(idx,1)[0]); } return out; }
function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* Perguntas */
function setAreaStyle(areaIndex){
  const qCard = $('#qCard');
  qCard.className = 'card cat-border A'+areaIndex;
  const dot = $('#areaDot');
  dot.style.background = getComputedStyle(qCard).getPropertyValue('--c').trim();
  dot.style.boxShadow = `0 0 16px color-mix(in oklab, ${dot.style.background} 40%, transparent)`;
}
function renderQuestion(){
  const total = state.drawn.length;
  const cur = state.drawn[state.idx];
  setAreaStyle(cur.areaIndex);
  $('#progress').textContent = `${state.idx+1}/${total}`;
  $('#progressFoot').textContent = `${state.idx+1}/${total}`;
  $('#areaBadge').textContent = `√Årea: ${cur.area}`;
  $('#levelBadge').textContent = `N√≠vel: ${cur.level===1?'B√°sico':cur.level===2?'Intermedi√°rio':'Avan√ßado'}`;
  $('#areaDot').textContent = AREA_ICONS[cur.area] || "‚Ä¢";
  $('#questionText').textContent = cur.question;
  $$('#likert .opt').forEach(b=> b.classList.remove('active'));
  hideExample();
}
/* resposta */
$('#likert').addEventListener('click', (e)=>{
  const btn = e.target.closest('.opt'); if(!btn) return;
  $$('#likert .opt').forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
  const v = Number(btn.dataset.v);
  state.answers.push(v);
  state.idx++;
  if(state.idx < state.drawn.length){ renderQuestion(); } else { toResults(); }
});

/* Emo√ß√£o */
$('#emojis').addEventListener('click', (e)=>{
  const el = e.target.closest('.emo'); if(!el) return;
  $$('#emojis .emo').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
  state.emotion = Number(el.dataset.e);
});

/* Exemplo (üí°) */
function showExample(){
  const cur = state.drawn[state.idx];
  const tip = $('#exTip');
  tip.textContent = "Exemplo: " + (cur.example || "Fa√ßa uma micro-a√ß√£o de 10 min que mexa o ponteiro.");
  tip.classList.add('show');
}
function hideExample(){ $('#exTip').classList.remove('show'); }
$('#btnExample').addEventListener('click', ()=>{
  const tip = $('#exTip');
  if(tip.classList.contains('show')) hideExample(); else showExample();
});

/* Ir para resultados */
function toResults(){
  if(!state.emotion){ alert('Selecione como voc√™ se sente hoje (carinhas).'); return; }
  const results = computeScoresAndProgress();
  drawDiamond(results);
  fillResults(results);
  buildAreaFilter();
  drawMini('all');
  goto('results');
}

/* C√°lculo + progress√£o */
function computeScoresAndProgress(){
  const areaVals = {}; const areaCounts = {}; const areaLevels = getLevels(state.user.name);
  state.drawn.forEach((item, i)=>{
    const v = (state.answers[i] ?? 3);
    const score10 = (v-1)*2.5;
    areaVals[item.area] = (areaVals[item.area]||0) + score10;
    areaCounts[item.area] = (areaCounts[item.area]||0) + 1;
  });
  const areaScores = AREAS.map(a=>{
    const s = (areaVals[a]||0)/(areaCounts[a]||1);
    return {area:a, score:+s.toFixed(2)};
  });
  const geral = +(areaScores.reduce((acc,x)=>acc+x.score,0)/areaScores.length).toFixed(2);

  areaScores.forEach(({area,score})=>{
    const meta = areaLevels[area] || {level:1, streak:0};
    if(score <= 4.0){ meta.level = 1; meta.streak = 0;
    }else{
      const target = meta.level===1?8.0:9.0;
      if(score >= target){
        meta.streak = (meta.streak||0) + 1;
        if(meta.level===1 && meta.streak>=3){ meta.level=2; meta.streak=0; }
        else if(meta.level===2 && meta.streak>=5){ meta.level=3; meta.streak=0; }
      }else{ meta.streak = 0; }
    }
    areaLevels[area]=meta;
  });
  setLevels(state.user.name, areaLevels);

  const payload = {date:state.sessionDate, areaScores, geral, emo:state.emotion};
  const hist = pushHistory(state.user.name, payload);
  state.lastSession = hist.length>=2 ? hist[hist.length-2] : null;
  return {areaScores, geral, hist};
}

/* Diamante */
function drawDiamond({areaScores}){
  const wrap = $('#diamondWrap'); wrap.innerHTML='';
  const W = wrap.clientWidth*0.92, H = wrap.clientHeight*0.92;
  const cx = W/2, cy = H/2, R = Math.min(W,H)*0.42;

  function polyPoints(scores){
    return scores.map((it,i)=>{
      const ang = (Math.PI*2 * i / scores.length) - Math.PI/2;
      const r = R * (it.score/10);
      return `${(cx + r*Math.cos(ang)).toFixed(1)},${(cy + r*Math.sin(ang)).toFixed(1)}`;
    }).join(' ');
  }

  const cur = polyPoints(areaScores);
  let prev = null;
  if(state.lastSession?.areaScores){
    const mapPrev = new Map(state.lastSession.areaScores.map(o=>[o.area,o.score]));
    const prevArr = AREAS.map(a=>({area:a, score: mapPrev.get(a) ?? 0}));
    prev = polyPoints(prevArr);
  }

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  for(let ring=2; ring<=10; ring+=2){
    const c = document.createElementNS(svgNS,'circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',R*(ring/10));
    c.setAttribute('fill','none'); c.setAttribute('stroke','#2e3342'); c.setAttribute('stroke-dasharray','4 6');
    svg.appendChild(c);
  }
  AREAS.forEach((name,i)=>{
    const ang = (Math.PI*2 * i / AREAS.length) - Math.PI/2;
    const lx = cx + (R+18)*Math.cos(ang);
    const ly = cy + (R+18)*Math.sin(ang);
    const t = document.createElementNS(svgNS,'text');
    t.setAttribute('x',lx); t.setAttribute('y',ly); t.setAttribute('fill','#aab3d4'); t.setAttribute('font-size','10');
    t.setAttribute('text-anchor',(Math.cos(ang)>0.4)?'start':(Math.cos(ang)<-0.4)?'end':'middle');
    t.textContent = name.replace(' e ','/');
    svg.appendChild(t);
  });

  if(prev){
    const p = document.createElementNS(svgNS,'polygon');
    p.setAttribute('points',prev); p.setAttribute('fill','none'); p.setAttribute('stroke','#9aa4c8'); p.setAttribute('stroke-dasharray','6 4'); p.setAttribute('stroke-width','2');
    svg.appendChild(p);
  }
  const poly = document.createElementNS(svgNS,'polygon');
  poly.setAttribute('points',cur); poly.setAttribute('fill','rgba(247,208,64,.18)'); poly.setAttribute('stroke','var(--accent)'); poly.setAttribute('stroke-width','2');
  svg.appendChild(poly);

  wrap.appendChild(svg);
  $('#resultDateTag').textContent = `Sess√£o: ${state.sessionDate}${state.lastSession?` | √öltima: ${state.lastSession.date}`:''}`;
}

/* KPIs + IA mock + melhorias/elogios */
function fillResults({areaScores, geral, hist}){
  $('#kpiGeral').textContent = geral.toFixed(2);
  const emoMap = {1:'üòî Triste',2:'üòü Preocupado',3:'üòê Neutro',4:'üôÇ Bem',5:'üòÉ Radiante'};
  $('#kpiEmo').textContent = emoMap[state.emotion] || '‚Äî';

  const sorted = [...areaScores].sort((a,b)=>a.score-b.score);
  const attention = sorted.slice(0,3).map(x=>x.area).join(', ');
  $('#kpiAtencao').textContent = attention || 'OK';

  const trend = computeTrend(hist);
  const lowest = sorted[0], highest = sorted[sorted.length-1];
  $('#aiCritica').innerHTML = `<strong>Cr√≠tica:</strong> ${aiCritica(lowest, trend)}`;
  $('#aiRecon').innerHTML   = `<strong>Reconhecimento:</strong> ${aiRecon(highest, trend)}`;

  const improves = microAcoes(sorted.slice(0,3).map(x=>x.area));
  const praises  = elogios(sorted.slice(-3).map(x=>x.area));
  $('#improveList').innerHTML = `‚Ä¢ Foco desta semana: <em>${improves.titulo}</em><br>‚Äî ${improves.itens.join('<br>‚Äî ')}`;
  $('#praiseList').innerHTML  = `‚Ä¢ Conquistas vis√≠veis: <em>${praises.titulo}</em><br>‚Äî ${praises.itens.join('<br>‚Äî ')}`;
}
function computeTrend(hist){
  if(!hist || hist.length<2) return {geral:'+0', direcao:'neutro'};
  const a = hist[hist.length-1].geral, b = hist[hist.length-2].geral;
  const dif = +(a-b).toFixed(2);
  return {geral:(dif>=0?'+':'')+dif, direcao: dif>0?'alta':dif<0?'queda':'neutro'};
}
function aiCritica(low, trend){
  if(!low) return "Sem dados suficientes para cr√≠tica.";
  const severo = low.score<=4.0;
  const msgA = severo
    ? `Queda cr√≠tica em <b>${low.area}</b> (${low.score.toFixed(1)}/10). Foque 1 micro-a√ß√£o por 7 dias.`
    : `Ponto fraco: <b>${low.area}</b> (${low.score.toFixed(1)}/10). Consist√™ncia inst√°vel.`;
  const msgB = trend.direcao==='queda'
    ? ` Nota geral em <b>${trend.geral}</b>. Corte 1 distra√ß√£o por 72h.`
    : ``;
  return `${msgA}${msgB}`;
}
function aiRecon(high, trend){
  if(!high) return "Sem dados.";
  const msgA = `For√ßa: <b>${high.area}</b> (${high.score.toFixed(1)}/10). Alavanca do per√≠odo.`;
  const msgB = trend.direcao==='alta'
    ? ` Evolu√ß√£o em <b>${trend.geral}</b>. Mantenha cad√™ncia.`
    : ` Sustente qualidade sem picos.`;
  return `${msgA}${msgB}`;
}
function microAcoes(areas){
  const mapa = {
    "Sa√∫de F√≠sica B√°sica":["Higiene do sono hoje (telas off 1h).","Hidrata√ß√£o vis√≠vel (garrafa).","Caminhada 20 min, sem corrida."],
    "Performance e Vitalidade":["1 bloco de foco (25 min).","1 pausa consciente (2 min).","Definir 3 MITs de amanh√£."],
    "Resili√™ncia Emocional":["Respira√ß√£o 4-4-6 (3x/dia).","Nomear a emo√ß√£o antes de agir.","Pedir ajuda para 1 tarefa."],
    "Finan√ßas Pessoais":["Registrar 100% dos gastos hoje.","Excluir 1 sup√©rfluo.","Definir limite por categoria."],
    "Autoconhecimento":["Di√°rio de 5 linhas.","Aplicar 1 valor numa decis√£o.","3 min de sil√™ncio intencional."]
  };
  const top = areas[0] || "Autoconhecimento";
  const itens = mapa[top] || ["Defina 1 micro-a√ß√£o (‚â§10 min).","Repita por 7 dias.","Revise ao final com honestidade."];
  return {titulo: top, itens};
}
function elogios(areas){
  const frases = {
    "Aprendizado Cont√≠nuo":["Curiosidade virou estrutura.","Registro que evita esquecimento.","Aplicou no mundo real."],
    "Pensamento Cr√≠tico":["Decis√£o com crit√©rio, n√£o ru√≠do.","Buscou vis√£o contr√°ria.","Erros viraram estudo."],
    "Carreira e Prop√≥sito":["Mais sentido no trabalho.","Feedback como rotina.","Apoio ao crescimento de algu√©m."]
  };
  const top = areas[areas.length-1] || "Aprendizado Cont√≠nuo";
  const itens = frases[top] || ["Const√¢ncia notada.","Qualidade crescente.","Evolu√ß√£o vis√≠vel."];
  return {titulo: top, itens};
}

/* Filtros por √°rea/per√≠odo */
function buildAreaFilter(){
  const sel = $('#selArea'); sel.innerHTML = '';
  AREAS.forEach((a,i)=>{
    const op = document.createElement('option');
    op.value = a; op.textContent = ` ${AREA_ICONS[a]}  ${a}`;
    sel.appendChild(op);
  });
  sel.addEventListener('change', ()=> drawMini($('#selPeriodo').value));
  $('#selPeriodo').addEventListener('change', (e)=> drawMini(e.target.value));
}
function drawMini(periodo){
  const area = $('#selArea').value || AREAS[0];
  const box = $('#miniChart'); box.innerHTML='';
  const hist = getHistory(state.user.name);
  if(hist.length===0){ box.textContent='Sem hist√≥rico suficiente.'; return; }

  let data = hist.map(h=>({d:h.date, s:(h.areaScores.find(x=>x.area===area)||{score:0}).score}));
  if(periodo!=='all'){
    const n = Number(periodo);
    data = data.slice(-n);
  }

  const W = box.clientWidth-20, H = box.clientHeight-20, p=10;
  const xs = (i)=> p + i*( (W-2*p)/Math.max(1,(data.length-1)) );
  const min = 0, max = 10;
  const ys = (v)=> H - p - ( (v-min)/(max-min) )*(H-2*p);

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  for(let k=2;k<=10;k+=2){
    const y = ys(k);
    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1',p); line.setAttribute('x2',W-p); line.setAttribute('y1',y); line.setAttribute('y2',y);
    line.setAttribute('stroke','#2e3342'); line.setAttribute('stroke-dasharray','4 6'); svg.appendChild(line);
  }

  if(data.length>=2){
    const d = data.map((pt,i)=> `${i===0?'M':'L'} ${xs(i)} ${ys(pt.s)}`).join(' ');
    const path = document.createElementNS(svgNS,'path'); path.setAttribute('d',d);
    path.setAttribute('fill','none'); path.setAttribute('stroke','#5fb3ff'); path.setAttribute('stroke-width','2.2');
    svg.appendChild(path);
  }

  data.forEach((pt,i)=>{
    const c = document.createElementNS(svgNS,'circle');
    c.setAttribute('cx',xs(i)); c.setAttribute('cy',ys(pt.s)); c.setAttribute('r',3.4);
    c.setAttribute('fill','#f7d040'); svg.appendChild(c);
  });

  box.appendChild(svg);
}

/* Finalizar */
$('#btnFinish').addEventListener('click', ()=>{
  state = { user:null,sessionDate:null,drawn:[],idx:0,answers:[],emotion:null,lastSession:null };
  goto('login'); bootstrapAvatars();
});

/* Redesenhar diamante no resize */
window.addEventListener('resize', ()=>{
  if($('#results').classList.contains('active') && state.user){
    const last = getLastHistory(state.user.name);
    if(last) drawDiamond({areaScores:last.areaScores});
  }
});
</script>
</body>
</html>

<!-- ====================== BC_SYNC ADDON (Sheets) ====================== -->
<script>
(function(){
  const LSKEY = 'bc_sync_cfg';
  function loadCfg(){ try { return JSON.parse(localStorage.getItem(LSKEY)||'{}'); } catch { return {}; } }
  function saveCfg(c){ localStorage.setItem(LSKEY, JSON.stringify(c)); }
  let cfg = Object.assign({endpoint:'', token:'', enabled:false}, loadCfg());

  const badge = document.createElement('div');
  badge.id = 'bcSyncBadge';
  badge.style.position='absolute';
  badge.style.left='16px';
  badge.style.top='12px';
  badge.style.padding='6px 10px';
  badge.style.border='1px solid var(--line)';
  badge.style.borderRadius='999px';
  badge.style.fontSize='12px';
  badge.style.background='#141722';
  badge.style.color='#a9b0cf';
  badge.style.opacity='0.92';
  badge.style.pointerEvents='auto';
  badge.style.cursor='pointer';
  badge.title='Clique para abrir Config';
  updateBadge();
  document.getElementById('appHeader').appendChild(badge);
  badge.addEventListener('click', ()=> document.getElementById('modalConfig').classList.add('show'));

  function updateBadge(status){
    if(status==='ok'){ badge.textContent='Sheets: ‚úÖ'; badge.style.borderColor='#2d6'; }
    else if(status==='err'){ badge.textContent='Sheets: ‚ö†Ô∏è'; badge.style.borderColor='#f90'; }
    else { badge.textContent = 'Sheets: ' + (cfg.enabled ? 'ON' : 'OFF'); badge.style.borderColor='#2b3042'; }
  }

  const sheet = document.querySelector('#modalConfig .sheet');
  const box = document.createElement('div');
  box.className='card';
  box.style.marginTop='12px';
  box.innerHTML = `
    <div class="card-head" style="margin-bottom:6px">
      <div class="card-head-title"><span>üîó</span><span>Conex√£o com Google Sheets (WebApp)</span></div>
    </div>
    <div class="row" style="justify-content:flex-start">
      <div style="flex:1; min-width:260px">
        <div class="hint">Endpoint (termina em <b>/exec</b>)</div>
        <input id="bc_ep" placeholder="https://script.google.com/macros/s/XXX/exec" style="width:100%; background:#0f1118; border:1px solid #2b3042; border-radius:10px; color:#e9eeff; padding:8px 10px">
      </div>
      <div style="width:240px">
        <div class="hint">Token</div>
        <input id="bc_tk" placeholder="seu_token" style="width:100%; background:#0f1118; border:1px solid #2b3042; border-radius:10px; color:#e9eeff; padding:8px 10px">
      </div>
      <label class="hint" style="display:flex; align-items:center; gap:8px; margin-left:6px">
        <input type="checkbox" id="bc_on">
        Ativar sincroniza√ß√£o autom√°tica
      </label>
    </div>
    <div class="row" style="justify-content:flex-start; margin-top:10px">
      <button class="btn" id="bc_ping">Testar conex√£o</button>
      <button class="btn btn-primary" id="bc_push">Sincronizar sess√£o agora</button>
      <button class="btn" id="bc_export">Exportar JSON (backup)</button>
    </div>
    <div class="hint" id="bc_msg" style="margin-top:6px">Dica: se n√£o configurado, o app segue 100% offline.</div>
  `;
  sheet.appendChild(box);

  document.getElementById('bc_ep').value = cfg.endpoint||'';
  document.getElementById('bc_tk').value = cfg.token||'';
  document.getElementById('bc_on').checked = !!cfg.enabled;

  document.getElementById('bc_ep').addEventListener('change', (e)=> { cfg.endpoint=e.target.value.trim(); saveCfg(cfg); updateBadge(); });
  document.getElementById('bc_tk').addEventListener('change', (e)=> { cfg.token=e.target.value.trim(); saveCfg(cfg); });
  document.getElementById('bc_on').addEventListener('change', (e)=> { cfg.enabled=e.target.checked; saveCfg(cfg); updateBadge(); });

  document.getElementById('bc_ping').addEventListener('click', async ()=>{
    const msg = document.getElementById('bc_msg');
    try{
      const ok = await ping(cfg.endpoint);
      msg.textContent = ok ? 'Conex√£o OK ‚úÖ' : 'Falhou (verifique publica√ß√£o do WebApp e acesso)';
      updateBadge(ok?'ok':'err');
    }catch(err){
      msg.textContent = 'Erro: ' + err.message;
      updateBadge('err');
    }
  });
  document.getElementById('bc_push').addEventListener('click', async ()=>{
    const m = document.getElementById('bc_msg');
    try{
      const payload = buildSessionPayload();
      if(!payload){ m.textContent='Sem sess√£o para enviar. Fa√ßa uma avalia√ß√£o e volte aqui.'; return; }
      const res = await sendIngest(payload);
      m.textContent = res && res.ok ? 'Enviado ‚úÖ' : ('Falhou: ' + (res && res.error || 'sem resposta'));
      updateBadge(res && res.ok ? 'ok' : 'err');
    }catch(err){
      m.textContent = 'Erro: ' + err.message;
      updateBadge('err');
    }
  });
  document.getElementById('bc_export').addEventListener('click', ()=>{
    const payload = buildSessionPayload(true);
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=`bora_crescer_${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
  });

  const _toResults = window.toResults;
  window.toResults = function(){
    _toResults.apply(this, arguments);
    if(cfg.enabled){
      const payload = buildSessionPayload();
      if(payload){ sendIngest(payload).then(res=> updateBadge(res && res.ok ? 'ok' : 'err')).catch(()=>updateBadge('err')); }
    }
  };

  async function ping(endpoint){
    if(!endpoint) return false;
    const u = new URL(endpoint);
    u.searchParams.set('ping','1');
    const r = await fetch(u.toString(), {method:'GET'});
    return r.ok;
  }

  function buildSessionPayload(includeAllHistory=false){
    if(!window.state || !state.user || !state.sessionDate) return null;
    const last = getLastHistory(state.user.name);
    if(!last) return null;
    const answers = (state.answers||[]).map((v,i)=>({
      area: state.drawn?.[i]?.area || '‚Äî',
      level: state.drawn?.[i]?.level || 1,
      choiceLikert: v,
      score10: (v-1)*2.5
    }));
    const payload = {
      action: 'ingestSession',
      token: cfg.token||'',
      user: { name: state.user.name || '‚Äî' },
      session: {
        date: state.sessionDate,
        emotion: state.emotion || null,
        geral: last.geral,
        areas: last.areaScores,
        answers
      }
    };
    if(includeAllHistory){
      payload.history = getHistory(state.user.name) || [];
      payload.levels  = getLevels(state.user.name) || {};
    }
    return payload;
  }

  async function sendIngest(payload){
    if(!cfg.endpoint){ throw new Error('Endpoint n√£o configurado.'); }
    const r = await fetch(cfg.endpoint, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    let j=null; try{ j = await r.json(); }catch{ /* ignore */ }
    return j || { ok: r.ok };
  }

})();
</script>